services:
  # ===============================================
  # 1. SERVI√áO DE BANCO DE DADOS (Managed Postgres)
  #    Render recomenda usar Postgres gerenciado em vez de container MySQL
  #    para persist√™ncia de dados em produ√ß√£o. 
  #    Contudo, se voc√™ precisa usar MySQL, usaremos um MySQL gerenciado.
  # ===============================================
  - type: pserv # Tipo de servi√ßo persistente (Banco de Dados)
    name: real-state-db
    plan: starter # Plano b√°sico (ou use 'standard' dependendo da escala)
    
    # üîë Vari√°veis de ambiente que Render ir√° injetar no container PHP e no MySQL
    # O Render criar√° o HOST, USER, PASS e DATABASE automaticamente
    # Acessaremos essas vari√°veis no PHP via getenv()

    # NOTA: Render gerencia volumes e redes, eliminando 'ports' e 'volumes' manuais
    # NOTA: Para Docker Compose com MySQL, o Render prefere usar a URL de conex√£o
    #       injete as credenciais como vari√°veis de ambiente para o PHP usar.
    
    # Este servi√ßo ir√° provisionar um banco de dados gerenciado MySQL ou PostgreSQL.
    # Se voc√™ for usar o container MySQL do compose, precisaria de um Persistent Disk,
    # mas o Render recomenda servi√ßos gerenciados para DBs.
    
  # ===============================================
  # 2. SERVI√áO DE APLICA√á√ÉO PHP (Rodando PHP-FPM)
  #    Isto √© um Background Worker que o Nginx ir√° se conectar.
  # ===============================================
  - type: worker # Tipo worker, pois roda o PHP-FPM em segundo plano
    name: php-fpm
    # üîë O Render usa o Dockerfile que est√° no seu reposit√≥rio para construir
    #    a imagem.
    dockerfilePath: infra/Dockerfile 
    
    # Regra de Build: Somente reconstruir se o Dockerfile ou o composer.json mudar
    autoDeploy: true 
    
    # Define a porta do PHP-FPM (9000, conforme seu Dockerfile)
    envVars:
      - key: PORT
        value: 9000
      - key: DB_HOST
        sync: false # Render ir√° injetar o HOST do servi√ßo 'real-state-db'
      - key: DB_USER
        sync: false # Render ir√° injetar o USER do servi√ßo 'real-state-db'
      - key: DB_PASS
        sync: false # Render ir√° injetar o PASS do servi√ßo 'real-state-db'
      - key: DB_DATABASE
        sync: false # Render ir√° injetar o DATABASE do servi√ßo 'real-state-db'
      - key: TZ
        value: America/Sao_Paulo
      - key: PHP_INI_DATE_TIMEZONE
        value: America/Sao_Paulo # Mantido para consist√™ncia
    
    # NOTA: O Render gerencia automaticamente as depend√™ncias de rede.
    
  # ===============================================
  # 3. SERVI√áO WEB (Nginx/Front-end)
  #    Este √© o ponto de entrada p√∫blico.
  # ===============================================
  - type: web # Tipo Web (recebe tr√°fego externo e gerencia a porta 80/443)
    name: real-state-web
    # Imagem base do Nginx, conforme seu compose
    image: nginx:stable-alpine 
    
    # Porta exposta para o mundo (Render gerencia o mapeamento 80/443)
    port: 80 
    
    # Comando de inicializa√ß√£o: Nginx
    command: "nginx -g 'daemon off;'" 
    
    # Mapeamento do c√≥digo e configura√ß√£o
    # Render usa 'sync' para manter o c√≥digo do repo atualizado
    # O arquivo de configura√ß√£o do Nginx √© copiado para o container
    mounts:
      - path: /etc/nginx/conf.d/default.conf
        # O arquivo de configura√ß√£o do Render est√° na raiz do reposit√≥rio
        # Adaptamos para que ele use o seu arquivo nginx.conf
        content: |
          server {
              listen 80;
              server_name localhost;
              root /var/www/html/public;
              index index.php index.html index.htm;
              
              location / {
                  try_files $uri $uri/ /index.php?$args;
              }
              
              location ~ \.php$ {
                  # üîë Render resolve o fastcgi_pass para o nome do servi√ßo PHP
                  fastcgi_pass php-fpm:9000; 
                  fastcgi_index index.php;
                  include fastcgi_params;
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                  fastcgi_param PATH_INFO $fastcgi_path_info;
              }
          }
    
    # Assegura que o servi√ßo PHP-FPM esteja rodando antes de iniciar o Nginx
    dependsOn:
      - php-fpm